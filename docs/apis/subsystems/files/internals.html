<!doctype html>
<html lang="en-AU" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-apis/subsystems/files/internals">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.18">
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-L9EE8RW5B1"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-L9EE8RW5B1",{})</script>
<link rel="icon" href="/devdocs/img/icons/orange_m.svg">
<link rel="manifest" href="/devdocs/manifest.json">
<meta name="theme-color" content="rgb(208, 99, 0)">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#000">
<link rel="apple-touch-icon" href="/devdocs/img/icons/maskable_icon.png">
<link rel="mask-icon" href="/devdocs/img/icons/maskable_icon.png" color="rgb(208, 99, 0)">
<meta name="msapplication-TileImage" content="/devdocs/img/icons/maskable_icon.png">
<meta name="msapplication-TileColor" content="#000"><title data-rh="true">File API internals | Moodle</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://moodle.github.io/devdocs/docs/apis/subsystems/files/internals"><meta data-rh="true" name="docusaurus_locale" content="en-AU"><meta data-rh="true" name="docsearch:language" content="en-AU"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="File API internals | Moodle"><meta data-rh="true" name="description" content="The goals of the File API are to:"><meta data-rh="true" property="og:description" content="The goals of the File API are to:"><link data-rh="true" rel="icon" href="/devdocs/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://moodle.github.io/devdocs/docs/apis/subsystems/files/internals"><link data-rh="true" rel="alternate" href="https://moodle.github.io/devdocs/docs/apis/subsystems/files/internals" hreflang="en-AU"><link data-rh="true" rel="alternate" href="https://moodle.github.io/devdocs/docs/apis/subsystems/files/internals" hreflang="x-default"><link rel="stylesheet" href="/devdocs/assets/css/styles.c7535a9b.css">
<link rel="preload" href="/devdocs/assets/js/runtime~main.35479765.js" as="script">
<link rel="preload" href="/devdocs/assets/js/main.7da29e98.js" as="script">
</head>
<body class="navigation-with-keyboard" data-theme="light">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/devdocs/"><div class="navbar__logo"><img src="/devdocs/img/Moodle_M_icon.svg" alt="Moodle" class="themedImage_W2Cr themedImage--light_TfLj" height="32px" width="32px"><img src="/devdocs/img/Moodle_M_icon.svg" alt="Moodle" class="themedImage_W2Cr themedImage--dark_oUvU" height="32px" width="32px"></div><b class="navbar__title">Moodle</b></a><a class="navbar__item navbar__link navbar__link--active" href="/devdocs/docs/gettingstarted/quickstart">Guides</a><a class="navbar__item navbar__link" href="/devdocs/general/community">Community</a><a class="navbar__item navbar__link" href="/devdocs/general/development/process">Process</a><a class="navbar__item navbar__link" href="/devdocs/general/development/policies/codingstyle">Policies</a><a class="navbar__item navbar__link" href="/devdocs/general/development/tools">Tools</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" href="/devdocs/docs">master</a><ul class="dropdown__menu"><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/devdocs/docs/apis/subsystems/files/internals">master</a></li><li><a class="dropdown__link" href="/devdocs/docs/4.0">4.0</a></li><li><a href="https://docs.moodle.org/dev/" target="_blank" rel="noopener noreferrer" class="dropdown__link">Legacy documentation<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a class="dropdown__link" href="/devdocs/versions">All versions</a></li></ul></div><a href="https://github.com/moodle/moodle" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_S7eR colorModeToggle_vKtC"><button class="clean-btn toggleButton_rCf9 toggleButtonDisabled_Pu9x" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_v35p"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_nQuB"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="dsla-search-wrapper"><div class="dsla-search-field" data-tags="default,docs-default-current,docs-general-current"></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper"><div class="docPage_P2Lg"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_RiI4" type="button"></button><aside class="theme-doc-sidebar-container docSidebarContainer_rKC_"><div class="sidebar_RiAD"><nav class="menu thin-scrollbar menu_izAj"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/devdocs/docs">Introduction</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/devdocs/docs/gettingstarted/quickstart">Getting started</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/devdocs/docs/guides/javascript">Developer guides</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/devdocs/docs/apis">API guides</a><button aria-label="Toggle the collapsible sidebar category &#x27;API guides&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/devdocs/docs/apis/commonfiles">Common files</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/devdocs/docs/category/plugin-types">Plugin types</a><button aria-label="Toggle the collapsible sidebar category &#x27;Plugin types&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" tabindex="0" href="/devdocs/docs/category/subsystems">Subsystems</a><button aria-label="Toggle the collapsible sidebar category &#x27;Subsystems&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/devdocs/docs/apis/subsystems/access">Access API</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" tabindex="0" href="/devdocs/docs/apis/subsystems/files">File API</a><button aria-label="Toggle the collapsible sidebar category &#x27;File API&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/devdocs/docs/apis/subsystems/files/browsing">File Browser API</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/devdocs/docs/apis/subsystems/files/internals">File API internals</a></li></ul></li></ul></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1"><hr></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/devdocs/docs/release-notes">Release notes</a></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_FykI"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_DTRl"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></aside><main class="docMainContainer_TCnq"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_DM6M"><div class="docItemContainer_vinB"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Xlws" aria-label="breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/devdocs/">üè†</a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/devdocs/docs/apis"><span itemprop="name">API guides</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/devdocs/docs/category/subsystems"><span itemprop="name">Subsystems</span></a><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/devdocs/docs/apis/subsystems/files"><span itemprop="name">File API</span></a><meta itemprop="position" content="3"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="item name">File API internals</span><meta itemprop="position" content="4"></li></ul></nav><span class="theme-doc-version-badge badge badge--secondary">Version: master</span><div class="tocCollapsible_jdIR theme-doc-toc-mobile tocMobile_TmEX"><button type="button" class="clean-btn tocCollapsibleButton_Fzxq">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>File API internals</h1></header><p>The goals of the File API are to:</p><ul><li>allow files to be stored within Moodle, as part of the content</li><li>use a consistent and flexible approach for all file handling throughout Moodle</li><li>give components control over which users can access a file, using capabilities and other local rules</li><li>make it easy to determine which parts of Moodle use which files, to simplify operations like backup and restore</li><li>track where files originally came from</li><li>avoid redundant storage, when the same file is used twice</li><li>fully support Unicode file names, irrespective of the capabilities of the underlying file system</li><li>support alternative file systems, including cloud-based APIs</li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="overview">Overview<a class="hash-link" href="#overview" title="Direct link to heading">‚Äã</a></h2><p>The File API is a set of core interfaces to allow the rest of Moodle to store, serve, and manage files. It applies to all files that are part of the Moodle site&#x27;s content. It is not used for internal files, such as those in the following subdirectories:</p><ul><li><code>dataroot</code></li><li><code>temp</code></li><li><code>lang</code></li><li><code>cache</code></li><li><code>environment</code></li><li><code>filter</code></li><li><code>search</code></li><li><code>sessions</code></li><li><code>upgradelogs</code></li></ul><p>See the <a href="/devdocs/docs/apis/subsystems/files">File API</a> documentation for information on using the File API.</p><p>The API can be subdivided into the following parts:</p><ul><li><a href="#file-system"><em>File system</em></a> - Low level storage of file content, without access control</li><li><a href="#file-storage"><em>File storage</em></a> - Storage of file metadata</li><li><a href="#file-serving"><em>File serving</em></a> - Handle the retrieval and serving of files from the File storage API, including:<ul><li>serving the files on request</li><li>performing appropriate access checks</li></ul></li><li><em>File related user interfaces</em> - Provides the interface for uploading files, including:<ul><li>Form elements allowing users to select a file using the file picker, and have it stored within Moodle.</li><li>UI for users to manage their files, replacing the old course files UI</li></ul></li><li><em>File browsing API</em> - Allow code to browse and optionally manipulate the file areas, including:<ul><li>find information about available files in each area</li><li>print links to files</li><li>optionally move, rename, copy, delete, and perform other user-facing operations.</li></ul></li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="file-api-internals">File API internals<a class="hash-link" href="#file-api-internals" title="Direct link to heading">‚Äã</a></h2><h3 class="anchor anchorWithStickyNavbar_mojV" id="file-system">File System<a class="hash-link" href="#file-system" title="Direct link to heading">‚Äã</a></h3><p>The File System API allows for files to be stored in alternative underlying file systems, for example in an cloud-based API such as <a href="https://aws.amazon.com/s3" target="_blank" rel="noopener noreferrer">Amazon S3</a>. Each file is stored and retrieved using a <code>contenthash</code>.</p><p>The file content hash is calculated by taking a SHA1 hash of the content of the file. This should be unique enough so as to allow any number of files to be uploaded to the File API without any natural collisions occurring, and allows the File system to store a single copy of a file, no matter how many times that file content is used within user-generated content.</p><p>This means Moodle can not store two files with <em>different</em> content and the <em>same</em> SHA1 hash, luckily it is extremely unlikely that this would ever happen. Technically it is also possible to implement reliable collision tests (with some performance cost), though Moodle currently checks for this case using a simple file length check in addition to SHA1 hash.</p><div class="admonition admonition-info alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</h5></div><div class="admonition-content"><p>The default file system shipped with Moodle stores all files on disk within the <code>moodledata</code> sub-directory of <code>$CFG-&gt;dataroot</code>.</p><p>Suppose a file has a content hash of <code>081371cb102fa559e81993fddc230c79205232ce</code>, then it will be stored in on disk as <code>moodledata/filedir/08/13/081371cb102fa559e81993fddc230c79205232ce</code>.</p></div></div><div class="admonition admonition-tip alert alert--success"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Validation of files</h5></div><div class="admonition-content"><p>As files in the standard disk-based file storage API are named using their SHA1 hash, there is a simple way of validating files have not become corrupted using the &#x27;sha1sum&#x27; command available in most GNU/Linux distributions.</p><p>Where a file is correct then the filename will match the <code>sha1sum</code> of the file. for example:</p><div class="codeBlockContainer_I0IT language-console theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-console codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">  $ cd /moodlepath/moodledata/filedir/1d/df/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  $ sha1sum 1ddf5b375fcb74929cdd7efda4f47efc61414edf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  1ddf5b375fcb74929cdd7efda4f47efc61414edf  1ddf5b375fcb74929cdd7efda4f47efc61414edf</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>Where a file has become corrupted, these will differ:</p><div class="codeBlockContainer_I0IT language-console theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-console codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">  $ cd /moodlepath/moodledata/filedir/42/32/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  $ sha1sum 42327aac8ce5741f51f42be298fa63686fe81b7a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  9442188152c02f65267103d78167d122c87002cd  42327aac8ce5741f51f42be298fa63686fe81b7a</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="file-storage">File Storage<a class="hash-link" href="#file-storage" title="Direct link to heading">‚Äã</a></h3><p>The File Storage API is provided by the <code>\file_storage</code> class, and stores all metadata relating to a file. It interacts with the File System API and the <code>\stored_file</code> class to provide all low-level storage functionality.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="files-table">Files table<a class="hash-link" href="#files-table" title="Direct link to heading">‚Äã</a></h3><p>The File system API stores all file records in the <code>files</code> database table. This table contains one entry for each usage of a file. Enough information is kept here so that the file can be fully identified and retrieved again if necessary.</p><p>If, for example, the same image is used in a user&#x27;s profile, and a forum post, then there will be two rows in this table, one for each use of the file, and Moodle will treat the two as separate files, even though the file is only stored once on disc.</p><p>Entries with a file name of <code>.</code>represent directories. Directory entries like this are created automatically when a file is added within them.</p><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</h5></div><div class="admonition-content"><p>The name <code>files</code> is used in the plural form, even though it goes against the <a href="https://docs.moodle.org/dev/Database" target="_blank" rel="noopener noreferrer">coding guidelines</a> because <code>file</code> is a reserved word in some SQL dialects.</p></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="implementation-of-basic-operations">Implementation of basic operations<a class="hash-link" href="#implementation-of-basic-operations" title="Direct link to heading">‚Äã</a></h2><p>The low level access API is defined in the <code>\file_storage</code> class, which can be obtained using the <code>get_file_storage()</code> function, for example:</p><div class="codeBlockContainer_I0IT language-php theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-php codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token variable" style="color:#36acaa">$fs</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">get_file_storage</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>Details of common operations are documented in the <a href="/devdocs/docs/apis/subsystems/files">File System API</a> documentation</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="file-serving">File serving<a class="hash-link" href="#file-serving" title="Direct link to heading">‚Äã</a></h2><p>The File serving component of the File API deals with serving files to the user. This is typically in the form of browser requests. Moodle has several main files to handle serving of files. These include:</p><ul><li><code>draftfile.php</code> - the script used to serve files in a user&#x27;s <code>draft</code> file area.</li><li><code>pluginfile.php</code> - the script typically used by a plugin to access content.</li><li><code>tokenpluginfile.php</code> - the script typically used by a plugin to access content when a user is not logged in. This is usually in situations where a file is referred to in an e-mail or other similar scenario.</li></ul><p>It is the plugins responsibility to handle:</p><ul><li>access control</li><li>optional XSS protection - student submitted files must not be served with normal headers, we have to force download instead; ideally there should be second wwwroot for serving of untrusted files</li><li>links to these files are constructed on the fly from the relative links stored in database (see <a href="/devdocs/docs/apis/subsystems/files#generating-a-url-to-your-files">Generating a URL to your files</a> for further information).</li></ul><div class="admonition admonition-important alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>important</h5></div><div class="admonition-content"><p>Each plugin should only ever use the File Storage API to access its <strong>own files</strong>.</p></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="file-related-user-interfaces">File related user interfaces<a class="hash-link" href="#file-related-user-interfaces" title="Direct link to heading">‚Äã</a></h2><p>Files are typically selected by users and uploaded to Moodle using the File manager, and the file picker.</p><ul><li>The <strong>file manager</strong> is an interface used to view, and delete existing files, and to add new files.</li><li>The <strong>file picker</strong> is an interface, often accessed using the <em>file manager</em>, to select files for upload to Moodle. The file picker makes use of <a href="https://docs.moodle.org/dev/Repository%20API" target="_blank" rel="noopener noreferrer">file repositories</a>.</li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="form-fields">Form fields<a class="hash-link" href="#form-fields" title="Direct link to heading">‚Äã</a></h3><p>Moodle defines two form field types as part of the <code>formslib</code> integration, these are:</p><ul><li>The <code>filepicker</code>; and</li><li>the <code>filemanager</code>.</li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="integration-with-the-html-editor">Integration with the HTML editor<a class="hash-link" href="#integration-with-the-html-editor" title="Direct link to heading">‚Äã</a></h3><p>Each instance of an HTML editor can be told to store related files in a particular file area.</p><p>During editing, files are stored in a draft files area in the <code>user</code> component. Then when the form is submitted they are moved into the real file area.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="other-issues">Other issues<a class="hash-link" href="#other-issues" title="Direct link to heading">‚Äã</a></h2><h3 class="anchor anchorWithStickyNavbar_mojV" id="unicode-support-in-zip-format">Unicode support in zip format<a class="hash-link" href="#unicode-support-in-zip-format" title="Direct link to heading">‚Äã</a></h3><p>Zip format is an old standard for compressing files. It was created long before Unicode existed, and Unicode support was only recently added. There are several ways used for encoding of non-ASCII characters in path names, but unfortunately it is not very standardised. Most Windows packers use DOS encoding.</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="client-software">Client software<a class="hash-link" href="#client-software" title="Direct link to heading">‚Äã</a></h4><ul><li>Windows built-in compression - bundled with Windows, non-standard DOS encoding only</li><li>WinZip - shareware, Unicode option (since v11.2)</li><li>TotalCommander - shareware, single byte(DOS) encoding only</li><li>7-Zip - free, Unicode or DOS encoding depending on characters used in file name (since v4.58beta)</li><li>Info-ZIP - free, uses some weird character set conversions</li></ul><h4 class="anchor anchorWithStickyNavbar_mojV" id="php-extraction">PHP extraction<a class="hash-link" href="#php-extraction" title="Direct link to heading">‚Äã</a></h4><ul><li>Info-ZIP binary execution - no Unicode support at all, mangles character sets in file names (depends on OS, see docs), files must be copied to temp directory before compression and after extraction</li><li>PclZip PHP library - reads single byte encoded names only, problems with random problems and higher memory usage.</li><li>Zip PHP extension - kind of works in latest PHP versions</li></ul><h4 class="anchor anchorWithStickyNavbar_mojV" id="large-file-support">Large file support<a class="hash-link" href="#large-file-support" title="Direct link to heading">‚Äã</a></h4><ul><li>PHP running under 32bit operating systems does not support files &gt;2GB. This might be a potential problem for larger backups.</li></ul><h4 class="anchor anchorWithStickyNavbar_mojV" id="tar-alternative">Tar Alternative<a class="hash-link" href="#tar-alternative" title="Direct link to heading">‚Äã</a></h4><ul><li>tar with gzip compression - easy to implement in PHP + zlib extension (PclTar, Tar from PEAR or custom code)</li><li>no problem with unicode in *nix, Windows again expects DOS encoding :-(</li><li>seems suitable for backup/restore - yay!</li></ul><h4 class="anchor anchorWithStickyNavbar_mojV" id="summary">Summary<a class="hash-link" href="#summary" title="Direct link to heading">‚Äã</a></h4><ol><li>added zip processing class that fully hides the underlying library</li><li>using single byte encoding &quot;garbage in/garbage out&quot; approach for encoding of files in zip archives; add new <code>zipencoding</code> string into lang packs (for example <code>cp852</code> DOS charset for Czech locale) and use it during extraction (we might support true unicode later when PHP Zip extension does that)</li></ol><h3 class="anchor anchorWithStickyNavbar_mojV" id="tar-packer">Tar packer<a class="hash-link" href="#tar-packer" title="Direct link to heading">‚Äã</a></h3><p>In addition to the zip packer, a tar packer is also available. This creates
archives in a compressed tar format (similar to the file created by <code>tar -czf example.tar.gz mycontent</code>).</p><p>The packer is currently limited to ASCII filenames and individual files are limited to 8GB each, but unlike zip there is no limit on the total filesize. It uses the old POSIX format and is compatible with GNU tar using default options.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="see-also">See also<a class="hash-link" href="#see-also" title="Direct link to heading">‚Äã</a></h2><ul><li><a href="https://docs.moodle.org/dev/Repository%20API" target="_blank" rel="noopener noreferrer">Repository API</a></li><li><a href="https://docs.moodle.org/dev/Portfolio%20API" target="_blank" rel="noopener noreferrer">Portfolio API</a></li><li><a href="https://docs.moodle.org/dev/Resource%20module%20file%20API%20migration" target="_blank" rel="noopener noreferrer">Resource module file API migration</a></li><li><a href="https://tracker.moodle.org/browse/MDL-14589" target="_blank" rel="noopener noreferrer">MDL-14589</a> - File API Meta issue</li></ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-tags-row row margin-bottom--sm"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/devdocs/docs/tags/architecture">Architecture</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/devdocs/docs/tags/file-api">File API</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/devdocs/docs/tags/files">Files</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/devdocs/docs/tags/internals">Internals</a></li></ul></div></div><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/moodle/devdocs/edit/main/docs/apis/subsystems/files/internals.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_dcUD" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_foO9"><span class="theme-last-updated">Last updated<!-- --> on <b><time datetime="2022-04-28T06:59:44.000Z">28/04/2022</time></b> by <b>Sara Arjona</b></span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/devdocs/docs/apis/subsystems/files/browsing"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">File Browser API</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/devdocs/docs/release-notes"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Release notes</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_cNA8 thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#overview" class="table-of-contents__link toc-highlight">Overview</a></li><li><a href="#file-api-internals" class="table-of-contents__link toc-highlight">File API internals</a><ul><li><a href="#file-system" class="table-of-contents__link toc-highlight">File System</a></li><li><a href="#file-storage" class="table-of-contents__link toc-highlight">File Storage</a></li><li><a href="#files-table" class="table-of-contents__link toc-highlight">Files table</a></li></ul></li><li><a href="#implementation-of-basic-operations" class="table-of-contents__link toc-highlight">Implementation of basic operations</a></li><li><a href="#file-serving" class="table-of-contents__link toc-highlight">File serving</a></li><li><a href="#file-related-user-interfaces" class="table-of-contents__link toc-highlight">File related user interfaces</a><ul><li><a href="#form-fields" class="table-of-contents__link toc-highlight">Form fields</a></li><li><a href="#integration-with-the-html-editor" class="table-of-contents__link toc-highlight">Integration with the HTML editor</a></li></ul></li><li><a href="#other-issues" class="table-of-contents__link toc-highlight">Other issues</a><ul><li><a href="#unicode-support-in-zip-format" class="table-of-contents__link toc-highlight">Unicode support in zip format</a></li><li><a href="#tar-packer" class="table-of-contents__link toc-highlight">Tar packer</a></li></ul></li><li><a href="#see-also" class="table-of-contents__link toc-highlight">See also</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/devdocs/general/documentation">Developer docs</a></li><li class="footer__item"><a href="https://docs.moodle.org/" target="_blank" rel="noopener noreferrer" class="footer__link-item">User docs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://docs.moodle.org/dev/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Legacy docs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://moodle.org/mod/forum/view.php?id=55" target="_blank" rel="noopener noreferrer" class="footer__link-item">General Developer Forum<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/moodle" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/moodlehq" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">
Copyright ¬© 2022 Moodle Pty Ltd. Built with Docusaurus.</div></div></div></footer></div>
<script src="/devdocs/assets/js/runtime~main.35479765.js"></script>
<script src="/devdocs/assets/js/main.7da29e98.js"></script>
</body>
</html>